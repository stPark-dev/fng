{
  "name": "Fear & Greed Index Alert",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily 9AM KST",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0],
      "notes": "ë§¤ì¼ ì˜¤ì „ 9ì‹œ(KST) ì‹¤í–‰. n8n ì„œë²„ timezoneì´ Asia/Seoulì¸ì§€ í™•ì¸ í•„ìš”."
    },
    {
      "parameters": {
        "url": "https://api.alternative.me/fng/",
        "options": {
          "timeout": 10000
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "limit",
              "value": "2"
            }
          ]
        }
      },
      "id": "http-request",
      "name": "Fetch FNG API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 0],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000,
      "notes": "Alternative.me API í˜¸ì¶œ. limit=2ë¡œ ì˜¤ëŠ˜+ì–´ì œ ë°ì´í„° ìˆ˜ì‹ ."
    },
    {
      "parameters": {
        "jsCode": "/**\n * Fear & Greed Index - Transform & Alert Logic\n */\n\nconst CONFIG = {\n  EXTREME_FEAR_THRESHOLD: 20,\n  EXTREME_GREED_THRESHOLD: 80,\n  SIGNIFICANT_CHANGE: 15,\n  EMOJI_MAP: {\n    'Extreme Fear': 'ğŸ˜±',\n    'Fear': 'ğŸ˜¨',\n    'Neutral': 'ğŸ˜',\n    'Greed': 'ğŸ¤‘',\n    'Extreme Greed': 'ğŸš€',\n  },\n};\n\nconst unixToISO = (ts) => new Date(parseInt(ts, 10) * 1000).toISOString();\nconst safeParseInt = (val) => parseInt(val, 10) || 0;\nconst getEmoji = (cls) => CONFIG.EMOJI_MAP[cls] || 'ğŸ“Š';\nconst getChangeEmoji = (c) => c > 0 ? 'ğŸ“ˆ' : c < 0 ? 'ğŸ“‰' : 'â¡ï¸';\n\ntry {\n  const apiResponse = $input.all()[0].json;\n  const fngData = apiResponse?.data;\n\n  if (!Array.isArray(fngData) || fngData.length < 2) {\n    throw new Error('Invalid API response');\n  }\n\n  const todayRaw = fngData[0];\n  const yesterdayRaw = fngData[1];\n\n  const todayVal = safeParseInt(todayRaw.value);\n  const yesterdayVal = safeParseInt(yesterdayRaw.value);\n  const todayClassification = todayRaw.value_classification || 'Unknown';\n\n  const change = todayVal - yesterdayVal;\n  const absChange = Math.abs(change);\n\n  const isExtremeFear = todayVal <= CONFIG.EXTREME_FEAR_THRESHOLD;\n  const isExtremeGreed = todayVal >= CONFIG.EXTREME_GREED_THRESHOLD;\n  const isSignificantChange = absChange >= CONFIG.SIGNIFICANT_CHANGE;\n\n  const shouldAlert = isExtremeFear || isExtremeGreed || isSignificantChange;\n\n  let alertMessage = '';\n  if (shouldAlert) {\n    const emoji = getEmoji(todayClassification);\n    const changeEmoji = getChangeEmoji(change);\n    const changeSign = change >= 0 ? '+' : '';\n\n    let alertType = '';\n    let actionMessage = '';\n\n    if (isExtremeFear) {\n      alertType = 'ğŸ”¥ *ê·¹ë‹¨ì  ê³µí¬ = ë§¤ìˆ˜ ê¸°íšŒ!*';\n      actionMessage = '\\n\\nğŸ’¡ *\"ê³µí¬ì— ì‚¬ê³ , í™˜í˜¸ì— íŒ”ì•„ë¼\"*\\nâš”ï¸ ì „êµ° ëŒê²© ì¤€ë¹„! ë‚¨ë“¤ì´ íŒ” ë•Œ ì‚¬ë¼!';\n    } else if (isExtremeGreed) {\n      alertType = 'âš ï¸ *ê·¹ë‹¨ì  íƒìš• = ì°¨ìµì‹¤í˜„ íƒ€ì´ë°!*';\n      actionMessage = '\\n\\nğŸ’¡ *\"í™˜í˜¸í•  ë•Œ íŒ”ì•„ë¼\"*\\nğŸ›¡ï¸ ìˆ˜ìµ í™•ë³´í•˜ê³  í˜„ê¸ˆ ë¹„ì¤‘ ëŠ˜ë ¤ë¼!';\n    } else {\n      alertType = 'âš¡ *ê¸‰ê²©í•œ ë³€ë™ ê°ì§€*';\n      actionMessage = '\\n\\nğŸ’¡ ì‹œì¥ ë³€ë™ì„± ì£¼ì‹œ í•„ìš”';\n    }\n\n    alertMessage = [\n      alertType,\n      '',\n      `${emoji} *Fear & Greed Index*`,\n      'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',\n      `ğŸ“Š í˜„ì¬ ì§€ìˆ˜: *${todayVal}* (${todayClassification})`,\n      `${changeEmoji} ì „ì¼ ëŒ€ë¹„: *${changeSign}${change}*`,\n      `ğŸ“… ì–´ì œ ì§€ìˆ˜: ${yesterdayVal}`,\n    ].join('\\n') + actionMessage;\n  }\n\n  return [{\n    json: {\n      value: todayVal,\n      value_classification: todayClassification,\n      timestamp: unixToISO(todayRaw.timestamp),\n      should_alert: shouldAlert,\n      alert_message: alertMessage,\n      change: change,\n    }\n  }];\n\n} catch (error) {\n  return [{\n    json: {\n      _error: true,\n      _error_message: error.message,\n      should_alert: false,\n    }\n  }];\n}"
      },
      "id": "code-transform",
      "name": "Transform & Check Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 0],
      "notes": "API ì‘ë‹µ íŒŒì‹±, ë³€ë™í­ ê³„ì‚°, ì•Œë¦¼ ì¡°ê±´ íŒë‹¨"
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "fng_logs",
        "fieldsToSend": "defineBelow",
        "fieldList": {
          "fieldValues": [
            {
              "fieldName": "value",
              "fieldValue": "={{ $json.value }}"
            },
            {
              "fieldName": "value_classification",
              "fieldValue": "={{ $json.value_classification }}"
            },
            {
              "fieldName": "timestamp",
              "fieldValue": "={{ $json.timestamp }}"
            }
          ]
        },
        "options": {
          "onConflict": "ignore"
        }
      },
      "id": "supabase-insert",
      "name": "Save to Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [660, 0],
      "credentials": {
        "supabaseApi": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      },
      "notes": "fng_logs í…Œì´ë¸”ì— INSERT. ì¤‘ë³µ ì‹œ ë¬´ì‹œ(idempotency)."
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_alert }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-should-alert",
      "name": "Should Alert?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 0],
      "notes": "ì•Œë¦¼ ì¡°ê±´ ì¶©ì¡± ì‹œì—ë§Œ Telegramìœ¼ë¡œ ë¶„ê¸°"
    },
    {
      "parameters": {
        "chatId": "REPLACE_WITH_CHAT_ID",
        "text": "={{ $json.alert_message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-send",
      "name": "Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1100, -100],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      },
      "notes": "Markdown í˜•ì‹ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡"
    },
    {
      "parameters": {},
      "id": "no-alert",
      "name": "No Alert Needed",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1100, 100],
      "notes": "ì•Œë¦¼ ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ì¢…ë£Œ"
    }
  ],
  "connections": {
    "Daily 9AM KST": {
      "main": [
        [
          {
            "node": "Fetch FNG API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch FNG API": {
      "main": [
        [
          {
            "node": "Transform & Check Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform & Check Alert": {
      "main": [
        [
          {
            "node": "Save to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Supabase": {
      "main": [
        [
          {
            "node": "Should Alert?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Alert?": {
      "main": [
        [
          {
            "node": "Send Telegram Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Alert Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Seoul"
  },
  "tags": [
    {
      "name": "crypto",
      "id": "1"
    },
    {
      "name": "etl",
      "id": "2"
    }
  ]
}
