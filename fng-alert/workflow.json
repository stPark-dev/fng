{
  "name": "Fear & Greed Index Alert",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily 9AM KST",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0],
      "notes": "ë§¤ì¼ ì˜¤ì „ 9ì‹œ(KST) ì‹¤í–‰. n8n ì„œë²„ timezoneì´ Asia/Seoulì¸ì§€ í™•ì¸ í•„ìš”."
    },
    {
      "parameters": {
        "url": "https://api.alternative.me/fng/",
        "options": {
          "timeout": 10000
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "limit",
              "value": "2"
            }
          ]
        }
      },
      "id": "http-request",
      "name": "Fetch FNG API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 0],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000,
      "notes": "Alternative.me API í˜¸ì¶œ. limit=2ë¡œ ì˜¤ëŠ˜+ì–´ì œ ë°ì´í„° ìˆ˜ì‹ ."
    },
    {
      "parameters": {
        "jsCode": "/**\n * Fear & Greed Index - Transform & Alert Logic\n * ëª¨ë“  êµ¬ê°„ì—ì„œ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±\n */\n\nconst EMOJI_MAP = {\n  'Extreme Fear': 'ğŸ˜±',\n  'Fear': 'ğŸ˜¨',\n  'Neutral': 'ğŸ˜',\n  'Greed': 'ğŸ¤‘',\n  'Extreme Greed': 'ğŸš€',\n};\n\nconst unixToISO = (ts) => new Date(parseInt(ts, 10) * 1000).toISOString();\nconst safeParseInt = (val) => parseInt(val, 10) || 0;\nconst getEmoji = (cls) => EMOJI_MAP[cls] || 'ğŸ“Š';\nconst getChangeEmoji = (c) => c > 0 ? 'ğŸ“ˆ' : c < 0 ? 'ğŸ“‰' : 'â¡ï¸';\n\n// êµ¬ê°„ë³„ ë©”ì‹œì§€ ì •ì˜\nconst getZoneMessage = (value) => {\n  if (value <= 10) {\n    return {\n      zone: 'ğŸ”¥ [ê³µí¬ ì§€ì˜¥] 0-10',\n      title: 'íŒ¨ë‹‰ì…€ ì ˆì •! ì˜¬ì¸ íƒ€ì´ë°?!',\n      tip: 'ì—­ì‚¬ì  ë°”ë‹¥ê¶Œ. ì›Œë Œ ë²„í•: \"ë‚¨ë“¤ì´ ê³µí¬ì— ë–¨ ë•Œ íƒìš•ì„ ë¶€ë ¤ë¼\"\\nâš”ï¸ ì „êµ° ëŒê²©! ë¶„í• ë§¤ìˆ˜ ì ê·¹ ê³ ë ¤!',\n      emoji: 'ğŸ©¸'\n    };\n  } else if (value <= 20) {\n    return {\n      zone: 'ğŸ˜± [ê·¹ë‹¨ì  ê³µí¬] 11-20',\n      title: 'ê³µí¬ ê·¹ëŒ€í™”! ë§¤ìˆ˜ ê¸°íšŒ í¬ì°©!',\n      tip: 'ì‹œì¥ì´ ê³¼ë„í•˜ê²Œ ë¹„ê´€ì . ëŒ€ë¶€ë¶„ì˜ ì•…ì¬ê°€ ê°€ê²©ì— ë°˜ì˜ë¨\\nğŸ’° ìš©ê¸°ìˆëŠ” ìê°€ ë¶€ë¥¼ ì–»ëŠ”ë‹¤! ë¶„í• ë§¤ìˆ˜ ì‹œì‘!',\n      emoji: 'ğŸ¯'\n    };\n  } else if (value <= 30) {\n    return {\n      zone: 'ğŸ˜¨ [ê³µí¬] 21-30',\n      title: 'ê³µí¬ ìš°ì„¸! ë§¤ìˆ˜ ê´€ì‹¬ êµ¬ê°„',\n      tip: 'ì•„ì§ ë‘ë ¤ì›€ì´ ì§€ë°°. ì¢‹ì€ ìì‚°ì„ ì‹¸ê²Œ ì‚´ ê¸°íšŒ\\nğŸ›’ ê´€ì‹¬ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì ê²€, ë¶„í• ë§¤ìˆ˜ ì¤€ë¹„!',\n      emoji: 'ğŸ‘€'\n    };\n  } else if (value <= 40) {\n    return {\n      zone: 'ğŸ˜° [ì•½í•œ ê³µí¬] 31-40',\n      title: 'ë¶ˆì•ˆí•œ ì‹œì¥, ê¸°íšŒ ì—¿ë³´ê¸°',\n      tip: 'ì‹œì¥ ì‹¬ë¦¬ ìœ„ì¶•. ì„£ë¶€ë¥¸ ë§¤ë„ë³´ë‹¤ ê´€ë§ or ì†ŒëŸ‰ ë§¤ìˆ˜\\nğŸ“ í¬íŠ¸í´ë¦¬ì˜¤ ì ê²€í•˜ê³  ì €ê°€ ë§¤ìˆ˜ ê¸°íšŒ íƒìƒ‰!',\n      emoji: 'ğŸ”'\n    };\n  } else if (value <= 60) {\n    return {\n      zone: 'ğŸ˜ [ì¤‘ë¦½] 41-60',\n      title: 'ê· í˜• ìƒíƒœ, ê´€ë§ ì¶”ì²œ',\n      tip: 'ëšœë ·í•œ ë°©í–¥ì„± ì—†ìŒ. ì¶”ì„¸ ì „í™˜ ì‹ í˜¸ ì£¼ì‹œ\\nâš–ï¸ ê¸‰í•˜ê²Œ ì›€ì§ì´ì§€ ë§ê³  ì‹œì¥ íë¦„ ê´€ì°°!',\n      emoji: 'â³'\n    };\n  } else if (value <= 70) {\n    return {\n      zone: 'ğŸ™‚ [ì•½í•œ íƒìš•] 61-70',\n      title: 'ë‚™ê´€ë¡  í™•ì‚°, ì£¼ì˜ ì‹œì‘',\n      tip: 'ì‹œì¥ì´ ê¸ì •ì . ì‹ ê·œ ë§¤ìˆ˜ë³´ë‹¤ ë³´ìœ  ì „ëµ ìœ ì§€\\nğŸ“Š ì¶”ê°€ ë§¤ìˆ˜ëŠ” ì‹ ì¤‘í•˜ê²Œ, ìµì ˆ ë¼ì¸ ì„¤ì •!',\n      emoji: 'ğŸ“ˆ'\n    };\n  } else if (value <= 80) {\n    return {\n      zone: 'ğŸ¤‘ [íƒìš•] 71-80',\n      title: 'ê³¼ì—´ ì‹ í˜¸! ì°¨ìµì‹¤í˜„ ê³ ë ¤',\n      tip: 'FOMO ì£¼ì˜! ì§€ê¸ˆ ë“¤ì–´ê°€ë©´ ë¬¼ë¦´ ìˆ˜ ìˆìŒ\\nğŸ’µ ìˆ˜ìµ ì¤‘ì¸ í¬ì§€ì…˜ ì¼ë¶€ ì •ë¦¬ ê³ ë ¤!',\n      emoji: 'âš ï¸'\n    };\n  } else if (value <= 90) {\n    return {\n      zone: 'ğŸš€ [ê·¹ë‹¨ì  íƒìš•] 81-90',\n      title: 'ë²„ë¸” ê²½ê³ ! ìµì ˆ íƒ€ì´ë°!',\n      tip: 'ì‹œì¥ ê³¼ì—´ ì‹¬ê°. ì—­ì‚¬ì ìœ¼ë¡œ ì¡°ì • ì„ë°• êµ¬ê°„\\nğŸ›¡ï¸ ìˆ˜ìµ í™•ë³´! í˜„ê¸ˆ ë¹„ì¤‘ í™•ëŒ€!',\n      emoji: 'ğŸ””'\n    };\n  } else {\n    return {\n      zone: 'ğŸ’¥ [íƒìš• ê·¹í•œ] 91-100',\n      title: 'ìœ í¬ë¦¬ì•„! íƒˆì¶œ ì¤€ë¹„!',\n      tip: 'ê·¹ë„ì˜ ë‚™ê´€. ì´ëŸ° ë•Œ ì‚¬ë©´ ê³ ì ì— ë¬¼ë¦°ë‹¤\\nğŸš¨ ë§¤ë„ ì‹ í˜¸! ìš•ì‹¬ ë²„ë¦¬ê³  ìˆ˜ìµ ì‹¤í˜„!',\n      emoji: 'ğŸƒ'\n    };\n  }\n};\n\ntry {\n  const apiResponse = $input.all()[0].json;\n  const fngData = apiResponse?.data;\n\n  if (!Array.isArray(fngData) || fngData.length < 2) {\n    throw new Error('Invalid API response');\n  }\n\n  const todayRaw = fngData[0];\n  const yesterdayRaw = fngData[1];\n\n  const todayVal = safeParseInt(todayRaw.value);\n  const yesterdayVal = safeParseInt(yesterdayRaw.value);\n  const todayClassification = todayRaw.value_classification || 'Unknown';\n\n  const change = todayVal - yesterdayVal;\n  const changeEmoji = getChangeEmoji(change);\n  const changeSign = change >= 0 ? '+' : '';\n  const emoji = getEmoji(todayClassification);\n\n  const zoneInfo = getZoneMessage(todayVal);\n\n  const alertMessage = [\n    `${zoneInfo.emoji} *${zoneInfo.zone}*`,\n    `*${zoneInfo.title}*`,\n    '',\n    `${emoji} *Fear & Greed Index*`,\n    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',\n    `ğŸ“Š í˜„ì¬ ì§€ìˆ˜: *${todayVal}* (${todayClassification})`,\n    `${changeEmoji} ì „ì¼ ëŒ€ë¹„: *${changeSign}${change}*`,\n    `ğŸ“… ì–´ì œ ì§€ìˆ˜: ${yesterdayVal}`,\n    '',\n    `ğŸ’¡ *íˆ¬ì íŒ*`,\n    zoneInfo.tip\n  ].join('\\n');\n\n  return [{\n    json: {\n      value: todayVal,\n      value_classification: todayClassification,\n      timestamp: unixToISO(todayRaw.timestamp),\n      should_alert: true,\n      alert_message: alertMessage,\n      change: change,\n    }\n  }];\n\n} catch (error) {\n  return [{\n    json: {\n      _error: true,\n      _error_message: error.message,\n      should_alert: false,\n    }\n  }];\n}"
      },
      "id": "code-transform",
      "name": "Transform & Check Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 0],
      "notes": "API ì‘ë‹µ íŒŒì‹±, ë³€ë™í­ ê³„ì‚°, ì•Œë¦¼ ì¡°ê±´ íŒë‹¨"
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "fng_logs",
        "fieldsToSend": "defineBelow",
        "fieldList": {
          "fieldValues": [
            {
              "fieldName": "value",
              "fieldValue": "={{ $json.value }}"
            },
            {
              "fieldName": "value_classification",
              "fieldValue": "={{ $json.value_classification }}"
            },
            {
              "fieldName": "timestamp",
              "fieldValue": "={{ $json.timestamp }}"
            }
          ]
        },
        "options": {
          "onConflict": "ignore"
        }
      },
      "id": "supabase-insert",
      "name": "Save to Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [660, 0],
      "credentials": {
        "supabaseApi": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      },
      "notes": "fng_logs í…Œì´ë¸”ì— INSERT. ì¤‘ë³µ ì‹œ ë¬´ì‹œ(idempotency)."
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_alert }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-should-alert",
      "name": "Should Alert?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 0],
      "notes": "ì•Œë¦¼ ì¡°ê±´ ì¶©ì¡± ì‹œì—ë§Œ Telegramìœ¼ë¡œ ë¶„ê¸°"
    },
    {
      "parameters": {
        "chatId": "REPLACE_WITH_CHAT_ID",
        "text": "={{ $json.alert_message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "telegram-send",
      "name": "Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1100, -100],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Telegram Bot"
        }
      },
      "notes": "Markdown í˜•ì‹ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡"
    },
    {
      "parameters": {},
      "id": "no-alert",
      "name": "No Alert Needed",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1100, 100],
      "notes": "ì•Œë¦¼ ì¡°ê±´ ë¯¸ì¶©ì¡± ì‹œ ì¢…ë£Œ"
    }
  ],
  "connections": {
    "Daily 9AM KST": {
      "main": [
        [
          {
            "node": "Fetch FNG API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch FNG API": {
      "main": [
        [
          {
            "node": "Transform & Check Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform & Check Alert": {
      "main": [
        [
          {
            "node": "Save to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Supabase": {
      "main": [
        [
          {
            "node": "Should Alert?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Alert?": {
      "main": [
        [
          {
            "node": "Send Telegram Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Alert Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Seoul"
  },
  "tags": [
    {
      "name": "crypto",
      "id": "1"
    },
    {
      "name": "etl",
      "id": "2"
    }
  ]
}
